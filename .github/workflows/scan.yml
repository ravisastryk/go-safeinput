name: Weekly Impact Scan

on:
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight
  workflow_dispatch:  # Manual trigger

permissions:
  contents: write

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Create metrics directory
        run: mkdir -p metrics

      - name: Run Scanner
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd cmd/scanner
          go run . -output ../../metrics/scan_$(date +%Y%m%d).json

      - name: Generate Report
        run: |
          latest=$(ls -t metrics/scan_*.json | head -1)
          
          cat > metrics/REPORT.md << EOF
          # CWE-502 Vulnerability Impact Report
          
          **Generated:** $(date -u +"%Y-%m-%d %H:%M UTC")
          **Scanner:** [go-safeinput](https://github.com/ravisastryk/go-safeinput)
          
          ## Summary
          
          | Metric | Value |
          |--------|-------|
          | Vulnerable Code Instances | $(jq '.total_vulnerable' $latest) |
          | Total Stars Affected | $(jq '.total_stars' $latest) |
          | Total Forks Affected | $(jq '.total_forks' $latest) |
          
          ## Patterns Detected
          
          | Pattern | Count | Severity |
          |---------|-------|----------|
          $(jq -r '.results[] | "| \(.pattern.name) | \(.count) | \(.pattern.severity) |"' $latest)
          
          ## Fix with go-safeinput
          
          \`\`\`go
          import "github.com/ravisastryk/go-safeinput/safedeserialize"
          
          var user User
          err := safedeserialize.JSON(data, &user)
          \`\`\`
          
          ## Links
          
          - [CWE-502](https://cwe.mitre.org/data/definitions/502.html)
          - [Semgrep Rule](https://github.com/semgrep/semgrep-rules)
          EOF

      - name: Update README badge
        run: |
          latest=$(ls -t metrics/scan_*.json | head -1)
          count=$(jq '.total_vulnerable' $latest)
          
          # Update badge in README if it exists
          if grep -q "vulnerable--" README.md 2>/dev/null; then
            sed -i "s/vulnerable--[0-9]*/vulnerable--$count/" README.md
          fi

      - name: Commit Results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create a new branch for the metrics update
          BRANCH_NAME="metrics-update-$(date +%Y%m%d)"
          git checkout -b "$BRANCH_NAME"

          git add metrics/
          git add README.md || true

          # Only commit and push if there are changes
          if ! git diff --staged --quiet; then
            git commit -m "Update impact metrics $(date +%Y-%m-%d)"
            git push origin "$BRANCH_NAME"

            # Create a pull request
            gh pr create \
              --title "Update CWE-502 Impact Metrics - $(date +%Y-%m-%d)" \
              --body "Automated weekly scan results showing CWE-502 vulnerability impact across the Go ecosystem." \
              --base main \
              --head "$BRANCH_NAME" || echo "PR already exists or couldn't be created"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
